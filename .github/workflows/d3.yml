name: Ultimate_File_Transfer_v2

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. 清理磁盘空间 (防止空间不足)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 1
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: 2. 检出代码
        uses: actions/checkout@v5

      - name: 3. 安装工具
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 p7zip-full

      - name: 4. 执行多线程下载
        env:
          SP_COOKIE: ${{ secrets.Y1 }}
        run: |
          mkdir -p ./download_dir
          
          # 【这里填入你的下载地址】
          URL="https://123-186-145-16.pd1.cjjd19.com/1135-user-share-pay-download-cdn.123295.com/123-723/fb7cb53f/1825715281-0/fb7cb53f729af52719eea7e6699ef2d3/c-m101?v=5&t=1768885691&r=MG2QQK&bzc=2&bzs=313832343930323239393a31363831323336313a383039343232303238383a313833383038373637393a3130&ur=vvmglvgvlvgaap&urn=0&s=176888569105f4a47a6a9dc538b9f5f9fcfa65e1c7&bzp=0&bi=1025404586&filename=SDHJ_1.30.00_20250617183321_0.app&x-mf-biz-cid=28f00fd9-a616-4696-9627-8d1051b7eb1a-3dab77&auto_redirect=0&ndcp=1&cache_type=1" 

          echo "--- 开始下载 ---"
          # 注意：增加了 --referer 尝试绕过 403 限制
          # 注意：增加了 --check-certificate=false 预防证书问题
          aria2c -x 16 -s 16 -k 1M -d ./download_dir -o MovieData.zip \
                 --header="Cookie: $SP_COOKIE" \
                 --referer="https://www.123pan.com/" \
                 --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
                 --check-certificate=false \
                 "$URL"

      - name: 5. 检查下载结果并 7z 分卷
        run: |
          mkdir -p ./release_files
          if [ -f ./download_dir/MovieData.zip ]; then
            FILE_SIZE=$(stat -c%s "./download_dir/MovieData.zip")
            if [ $FILE_SIZE -gt 1024 ]; then
              echo "--- 开始 7z 分卷打包 (1.8G/卷) ---"
              7z a ./release_files/MovieData.7z ./download_dir/MovieData.zip -v1800m -mx0
              rm -rf ./download_dir
            else
              echo "错误：下载的文件太小，可能是报错页面内容！"
              cat ./download_dir/MovieData.zip
              exit 1
            fi
          else
            echo "错误：未发现下载的文件，请检查链接是否失效！"
            exit 1
          fi

      - name: 6. 发布到 Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}"
          name: "Game_Backup_v${{ github.run_number }}"
          body: |
            ## 下载成功报告
            - 自动分卷：1.8GB/卷
            - 请下载所有分卷后，使用 7-Zip 解压第一个文件。
          files: ./release_files/MovieData.7z.*
